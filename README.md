# Выполнение тестового задания:

## Задание 1 - Создание магазина

### Что было реализовано:

Было реализовано API для взаимодействия с системой магазина, как основной фреймворк использовался FastAPI. Было сделано 2 эндпоинта для взаимодействия с системой:

```
"/products/": {
    "post": {
      "requestBody": {
        "required": true,
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/AddSale"
            }
          }
        }
      },
"/report": {
    "get": {
      "summary": "Get Report",
      "operationId": "get_report_report_get",
      "parameters": [
        {
          "name": "user-jwt",
          "in": "header",
          "required": true,
          "schema": {
            "type": "string",
            "title": "User Jwt"
          }
        }
      ],
```

Первый принимает на вход в заголовках JWT токен и json с данными в формате:
```
{
  "shop_name": "string",
  "date": "string",
  "items": {
    "additionalProp1": 0,
    "additionalProp2": 0,
    "additionalProp3": 0
  }
}
```
Из payload токена берется роль и магазин, с которым необходимо взаимодействовать, соответственно в теле передаются позиции, которые необходимо изменить в БД

Второй эндпоинт принимает только токен директоров, который хочет получить отчет и в ответ отдает .csv документ, в котором находится процент выполнения плана.

Соответственно была реализована система, в которую можно вносить данные о продажах за определенный день и получать отчеты о выполнении плана.

В качестве БД была взята sqlite для простоты реализации, схема БД представлена на рисунке:

![db](images/db.png)

Система способна: добавлять записи о продажах, считать процент выполнения плана, создавать .csv отчеты и выгружать их пользователю.

## Почему именно такая реализация?

Одной из проблем при создании сервиса стала авторизация пользователей, делать ее достаточно времязатратно, поэтому было принято решение использовать JWT токены без их валидации. Впоследствии можно вынести авторизацию в отдельный микросервис, который будет валидировать токены и в целом контролировать пользователей. Это также является причиной, почему в БД нет таблиц, которые были бы связаны с пользователями

Послкольку делать авторизацию по времени затратно, было принято решение сделать такую систему, которую можно масштабировать, дальше расширять функционал, например: добавление плана на месяц, добавление новых магазинов и т.д. С использованием данной реализации можно легко имплементировать отдельные сервисы или расширять новые. Из основных классов можно выделить DataBase, его можно дополнять новыми методами для запроса, при этом старые не будут ничего ломать. Отчет формируется с помощью класса ReportMaker, в нем объект словаря с помощью pandas формируется в датафрейм, а затем сохраняется в файл и передается обратно по запросу.

Отчет в csv:
![Описание картинки](images/csv.png)

Пример запроса для добавления продажи:
```
curl -X 'POST' \
  'http://127.0.0.1:8000/products/' \
  -H 'accept: application/json' \
  -H 'user-jwt: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoic2hvcF9jZW8iLCJzaG9wX2lkIjoxfQ.4JLW1eexuGXcFpnVx5pkSrQz7wui6lK6P39kItP-Tzk' \
  -H 'Content-Type: application/json' \
  -d '{
  "shop_name": "Магнит",
  "date": "2025-04-1",
  "items": {
    "Яблоки": 3
  }
}'
```
Пример запроса для получения отчета (в ответ будет файл .csv):
```
curl -X 'GET' \
  'http://127.0.0.1:8000/report' \
  -H 'accept: application/json' \
  -H 'user-jwt: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiZGlyZWN0b3JfY2VvIiwic2hvcF9pZCI6MX0.ucp29W4PY9AYMOVJCesOw6UQvYSCgyI1KZDrBklDaKM'

response:
 content-disposition: attachment; filename=report_shop1.csv 
 content-length: 226 
 content-type: text/csv; charset=utf-8 
 date: Sun,13 Apr 2025 19:48:42 GMT 
 server: uvicorn 
```

## Второе задание - ТГ бот для консультаций по вопросам трудового кодекса РФ

### Что было реализовано:

Был реалзиован ТГ бот (@tk_consultant_bot), как основной фреймворк использовался pyTelegramBotAPI. У бота есть 2 функции (за исключением help и start). Поскольку бот должен быть информативным и точным, была реализована возможность получить текст статьи из ТК РФ. Вторая функция - ИИ помошник, который по текстовому промпту пользователя может дать ему рекомендации и референс на статьи, которые можно прочитать для большего понимания вопроса.

### Какие проблемы возникли при реализации

Изначально была идея реализовать поиск по статьям, используя ключевые слова. Для этого был скачан PDF документ со всеми статьями, которые есть в ТК РФ на сегодняшний день. Он был распаршен, были удалены некоторые лишние пробелы. После этого, с помощью регулярного выражения был сформирован JSON:
```
article_num : article_test
```
Скрипты для парсинга есть в дирректории parce_json.

После этого было принято решение поместить их в БД и искать их по номеру статьи, которую дает пользователь. В последствии можно дополнять БД статьями, изменять их текст и расширять базу знаний программы.

Сам бот был создан с помощью BotFather и от него получен токен для API.

После реализации выдачи точного текста статьи пользователю было принято решение использовать LLM модель. Было найдено бесплатное API для NVIDIA: Llama 3.3 Nemotron Super 49B v1 и получен личный токен.

Для взаимодействия используется request. На вход нейросети дается контекст + примеры ответов и четкие указания в каком формате необходимо предоставить ответ. 

Были добавлены кнопки для удобства пользователя, а при старте работы выводится сообщение с объяснением функционала. 

Также была проблема, что некоторые статьи слишком длинные для API телеграмма, поэтому текст может делиться на несколько сообщений.

В общем и целом, AI ассистент отвечает неплохо, но из-за старой базы знаний достаточно часто статьи не совпадают с действительностью, для этого была дана установка, чтобы LLM писала в конце, что данные только для референса. Если получить доступ к более свежей и сложной модели, то будет работать лучше. Но для базовой реализации результат отличный (была попытка передать статьи LLM, однако тогда контекст был слишком большой, поэтому от этой идее пришлось отказаться).

Хотелось сделать кнопки более понятными(сейчас на них находятся команы), но в силу сжатого времени этот функционал не был реализован. 

Пример ответов на сообщения (сокращено для удобства чтения):
```
- User
    /ai_assistant
    Что делать, если хотят уволить при беременности
- Bot
    Законодательная основа: Ст. 81 ТК РФ (п. 6), ст. 237 ТК РФ, ст. 238 ТК РФ
    ### Объяснение законов
    1. Защита беременных от увольнения:
       - Ст. 237 ТК РФ: Раб...
    ### Рекомендации, если хотят уволить при беременности ...
    ### Важное примечание
    - Данные могут быть неточными в зависимости от изменений законодательства после 2025 г....

-User
    /article
- Bot
    Введите номер статьи (1, 2, 3.1):
-User
    120
- Bot
    Исчисление продолжительности ежегодных оплачиваемых отпусков
    Продолжительность ежегодных основного и дополнительных оплачиваемых отпусков работников
    исчисляется в календарных днях и максимальным пределом не ограничивается. Нерабочие праздничные
    дни, приходящиеся на период ежегодного основного или ежегодного дополнительного оплачиваемого
    отпуска, в число календарных дней отпуска не включаются.
    (в ред. Федерального закона от 30.06.2006 N 90-ФЗ)
    При исчислении общей продолжительности ежегодного оплачиваемого отпуска дополнительные
    оплачиваемые отпуска суммируются с ежегодным основным оплачиваемым отпуском.
```

В бота можно добавлять другие функции, другие модели. Масшатбирование предусмотрено.
